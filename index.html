<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACS Data Explorer</title>

    <!-- Favicon -->
    <!-- <link rel="icon" type="image/x-icon" href="images/favicon.ico"> -->

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Our CSS -->
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="stylesheet" href="./css/map.css">
    <link rel="stylesheet" href="./css/notifications.css">
</head>

<body>
    <!-- Loading Overlay -->
    <div id="app-loading" class="app-loading">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-inner"></div>
            </div>
            <h2>ACS Census Explorer</h2>
            <p class="loading-text">Loading ZIP code data...</p>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="progress-text">0%</div>
            </div>
            <div class="loading-stats">
                <div class="stat">
                    <i class="fas fa-database"></i>
                    <span id="cache-stats">Cache: Loading...</span>
                </div>
                <div class="stat">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="zip-stats">ZIPs: Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-fire"></i>
                    <h1>ACS Data Explorer</h1>
                    <span class="version">v5.0</span>
                </div>
                <div class="app-description">
                    Higher Education & Household Income ≥1,000
                </div>
            </div>

            <div class="header-controls">
                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">ZIP Codes:</span>
                        <span class="status-value" id="zipCount">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Cache:</span>
                        <span class="status-value" id="cacheStats">90d TTL</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Markers:</span>
                        <span class="status-value" id="dataStats">0</span>
                    </div>
                </div>

                <div class="header-buttons">
                    <!-- NEW GUIDE BUTTON -->
                    <button id="guideBtn" class="header-btn" title="Open User Guide" onclick="window.open('explainer.html', '_blank')">
                        <i class="fas fa-book-open"></i>
                    </button>
                    <button id="toggleLegend" class="header-btn" title="Toggle Legend">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button id="circleStatsBtn" class="header-btn" title="Circle Statistics">
                        <i class="fas fa-chart-pie"></i>
                    </button>
                    <button id="refreshData" class="header-btn" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="fullscreenBtn" class="header-btn" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-content">

                    <!-- About Panel -->
                    <div class="panel">
                        <div class="panel-header">
                            <i class="fas fa-map-marked-alt"></i>
                            <h3>How to use me</h3>
                            <div class="version">v5.0</div>
                        </div>
                        <div class="panel-content">
                            <div class="data-group">
                                <h4><i class="fas fa-info-circle"></i> About</h4>
                                <ul>
                                    <li><strong style="color: #3b82f6;">Blue:</strong> Education only (≥1,000 higher ed)</li>
                                    <li><strong style="color: #ef4444;">Red:</strong> Income only (≥1,000 HH ≥$100k)</li>
                                    <li><strong style="color: #8b5cf6;">Purple:</strong> Both criteria met</li>
                                    <li><strong>⭐ Star:</strong> Both criteria met (education + income)</li>
                                    <li><strong>Marker Size:</strong> √(value) × scale</li>
                                    <li><strong>Circle Analysis:</strong> Donut rings + radius-weighted (3x/2x/1x)</li>
                                </ul>
                                <p class="data-source">
                                    Data: ACS 2022 | Cache: 90 days<br>
                                    Threshold: 1,000+ for both criteria
                                </p>
                            </div>

                            <div class="action-buttons">
                                <button id="apiKeyBtn" class="btn btn-secondary">
                                    <i class="fas fa-key"></i> API Key
                                </button>
                                <button id="clearCacheBtn" class="btn btn-secondary">
                                    <i class="fas fa-trash-alt"></i> Clear Cache
                                </button>
                                <button id="reloadDataBtn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt"></i> Load Data
                                </button>
                            </div>
                            
                            <!-- NEW GUIDE LINK IN SIDEBAR -->
                            <div style="margin-top: 16px; text-align: center;">
                                <a href="explainer.html" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-book-open"></i> 
                                    <strong>Open Complete User Guide</strong> 
                                    <i class="fas fa-external-link-alt" style="font-size: 10px;"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- CIRCLES LIST -->
                    <div id="circles-list-container" class="circles-list-container">
                        <div class="circles-list-header">
                            <h4><i class="fas fa-draw-circle"></i> Analysis Rings</h4>
                            <div class="circles-count-badge">0 rings</div>
                        </div>
                        <div id="circles-list-scroll" class="circles-list-scroll">
                            <!-- Circles will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- STATISTICS PANEL -->
                    <div class="stats-panel">
                        <h6><i class="fas fa-chart-bar"></i> Data Statistics</h6>
                        <div id="statsContent">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Education Only:</span>
                                <strong style="color: #1e40af;" id="statEducation">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Income Only:</span>
                                <strong style="color: #991b1b;" id="statIncome">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Both Criteria:</span>
                                <strong style="color: #6b21a8;" id="statBoth">0</strong>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                <span>Total Markers:</span>
                                <strong style="color: #1f2937;" id="statTotal">0</strong>
                            </div>
                        </div>
                    </div>

                    <!-- KEYBOARD NAVIGATION PANEL -->
                    <div class="detailed-analysis">
                        <h5><i class="fas fa-keyboard"></i> Keyboard Navigation</h5>
                        <div class="analysis-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div><kbd>W</kbd> / <kbd>↑</kbd> Jump to next marker</div>
                            <div><kbd>S</kbd> / <kbd>↓</kbd> Jump to prev marker</div>
                            <div><kbd>A</kbd> / <kbd>←</kbd> Jump to prev marker</div>
                            <div><kbd>D</kbd> / <kbd>→</kbd> Jump to next marker</div>
                            <div><kbd>Shift</kbd> + Arrows</div>
                            <div>Pan map faster</div>
                            <div><kbd>+</kbd> / <kbd>-</kbd></div>
                            <div>Zoom in/out</div>
                            <div><kbd>F</kbd></div>
                            <div>Full Screen</div>
                            <div><kbd>R</kbd></div>
                            <div>Reset view</div>
                            <div><kbd>H</kbd></div>
                            <div>Toggle rings</div>
                            <div><kbd>C</kbd></div>
                            <div>Clear all rings</div>
                            <div><kbd>Esc</kbd></div>
                            <div>Cancel drawing</div>
                        </div>
                        <div
                            style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #3b82f6;">
                            <i class="fas fa-mouse-pointer"></i>
                            <strong>Draw Rings:</strong> Right-click + drag → Left-click to finish (max 5 miles)
                        </div>
                        
                        <!-- NEW GUIDE FOOTER LINK -->
                        <div style="margin-top: 16px; text-align: center; font-size: 12px;">
                            <a href="explainer.html" target="_blank" style="color: #8b5cf6; text-decoration: none;">
                                <i class="fas fa-book-open"></i> Need help? Read the Guide
                            </a>
                        </div>
                    </div>

                </div>
            </aside>

            <!-- Main Map Area -->
            <main class="map-area">
                <div id="mapContainer" class="map-container"></div>

                <!-- Map Controls - Bottom Right -->
                <div class="map-controls bottom-right">
                    <div class="map-control-group">
                        <button id="zoomInBtn" class="map-control-btn" title="Zoom In (+)">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button id="zoomOutBtn" class="map-control-btn" title="Zoom Out (-)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button id="resetViewBtn" class="map-control-btn" title="Reset View (R)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button id="locateBtn" class="map-control-btn" title="Locate Me">
                            <i class="fas fa-location-crosshairs"></i>
                        </button>
                    </div>
                </div>

                <!-- Map Legend with Toggles -->
                <div id="mapLegend" class="map-legend">
                    <div class="legend-header">
                        <div class="legend-title">Layer Controls</div>
                        <button class="legend-close">&times;</button>
                    </div>
                    <div class="legend-scale">
                        <div class="legend-item">
                            <input type="checkbox" id="toggleEducation" class="legend-checkbox" checked>
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <div class="legend-label">Education Only</div>
                        </div>
                        <div class="legend-item">
                            <input type="checkbox" id="toggleIncome" class="legend-checkbox" checked>
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <div class="legend-label">Income Only</div>
                        </div>
                        <div class="legend-item">
                            <input type="checkbox" id="toggleBoth" class="legend-checkbox" checked>
                            <div class="legend-color" style="background: #8b5cf6;"></div>
                            <div class="legend-label">Both Criteria</div>
                        </div>
                        <div class="legend-item">
                            <input type="checkbox" id="toggleRings" class="legend-checkbox" checked>
                            <div class="legend-color"
                                style="background: rgba(16,185,129,0.3); border: 2px solid #10b981;"></div>
                            <div class="legend-label">Analysis Rings</div>
                        </div>
                        <div class="legend-info">
                            ✓ = Visible | Right-click ring to delete
                        </div>
                    </div>
                </div>

                <!-- Coordinates Display -->
                <div class="coordinates-display">
                    <span><strong>Lat:</strong> <span id="currentLat">39.8283</span></span>
                    <span><strong>Lng:</strong> <span id="currentLng">-98.5795</span></span>
                    <span><strong>Zoom:</strong> <span id="currentZoom">4</span></span>
                    <span><strong>Mode:</strong> <span id="drawingMode">View</span></span>
                </div>
            </main>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                <div class="footer-left">
                    <span class="footer-brand">
                        <i class="fas fa-fire"></i>
                        ACS Ring Analyzer
                    </span>
                    <span class="footer-separator">•</span>
                    <span>WASD: Jump markers | R: Reset | C: Clear rings</span>
                    <span class="footer-separator">•</span>
                    <!-- NEW GUIDE LINK IN FOOTER -->
                    <a href="explainer.html" target="_blank" style="color: #3b82f6; text-decoration: none;">
                        <i class="fas fa-book-open"></i> Guide
                    </a>
                </div>
                <div class="footer-right">
                    <span id="footerCache">Cache: 90 days</span>
                    <span class="footer-separator">•</span>
                    <span>Right-click drag (max 5mi) → Left-click finish</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Notification Container -->
    <div class="notification-container"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Our JavaScript -->
    <script src="js/zipCodeIndex.js"></script>
    <script src="js/acsApiService.js"></script>
    <script src="js/spatialUtils.js"></script>
    <script src="js/mapVisualizer.js"></script>
    <script src="js/application.js"></script>

    <script>
        // Legend toggle handlers
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle legend visibility
            document.getElementById('toggleLegend')?.addEventListener('click', function () {
                const legend = document.getElementById('mapLegend');
                if (legend) {
                    legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
                }
            });

            // Legend close button
            document.querySelector('.legend-close')?.addEventListener('click', function () {
                document.getElementById('mapLegend').style.display = 'none';
            });

            // Layer toggle checkboxes
            document.getElementById('toggleEducation')?.addEventListener('change', function (e) {
                if (window.acsApp?.mapVisualizer) {
                    window.acsApp.mapVisualizer.toggleLayer('education', e.target.checked);
                }
            });

            document.getElementById('toggleIncome')?.addEventListener('change', function (e) {
                if (window.acsApp?.mapVisualizer) {
                    window.acsApp.mapVisualizer.toggleLayer('income', e.target.checked);
                }
            });

            document.getElementById('toggleBoth')?.addEventListener('change', function (e) {
                if (window.acsApp?.mapVisualizer) {
                    window.acsApp.mapVisualizer.toggleLayer('both', e.target.checked);
                }
            });

            document.getElementById('toggleRings')?.addEventListener('change', function (e) {
                if (window.acsApp?.mapVisualizer) {
                    window.acsApp.mapVisualizer.toggleRings(e.target.checked);
                }
            });

            // Update drawing mode indicator
            if (window.acsApp?.mapVisualizer) {
                const modeEl = document.getElementById('drawingMode');
                if (modeEl) {
                    setInterval(() => {
                        if (window.acsApp.mapVisualizer.isDrawing) {
                            modeEl.textContent = 'Drawing';
                            modeEl.style.color = '#10b981';
                        } else {
                            modeEl.textContent = 'View';
                            modeEl.style.color = '#6b7280';
                        }
                    }, 100);
                }
            }
        });
    </script>
</body>

</html>