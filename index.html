<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACS Data Explorer</title>

    <!-- Favicon -->
    <!-- <link rel="icon" type="image/x-icon" href="images/favicon.ico"> -->

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Our CSS -->
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="stylesheet" href="./css/map.css">
    <link rel="stylesheet" href="./css/notifications.css">
</head>

<body>
    <!-- Loading Overlay -->
    <div id="app-loading" class="app-loading">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-inner"></div>
            </div>
            <h2>ACS Census Explorer</h2>
            <p class="loading-text">Loading ZIP code data...</p>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="progress-text">0%</div>
            </div>
            <div class="loading-stats">
                <div class="stat">
                    <i class="fas fa-database"></i>
                    <span id="cache-stats">Cache: Loading...</span>
                </div>
                <div class="stat">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="zip-stats">ZIPs: Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-fire"></i>
                    <h1>ACS Data Explorer</h1>
                    <span class="version">v5.0</span>
                </div>
                <div class="app-description">
                    Higher Education & Household Income ‚â•1,000
                </div>
            </div>

            <div class="header-controls">
                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">ZIP Codes:</span>
                        <span class="status-value" id="zipCount">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Cache:</span>
                        <span class="status-value" id="cacheStats">90d TTL</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Markers:</span>
                        <span class="status-value" id="dataStats">0</span>
                    </div>
                </div>

                <div class="header-buttons">
                    <button id="toggleLegend" class="header-btn" title="Toggle Legend">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button id="circleStatsBtn" class="header-btn" title="Circle Statistics">
                        <i class="fas fa-chart-pie"></i>
                    </button>
                    <button id="refreshData" class="header-btn" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="fullscreenBtn" class="header-btn" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar - REORDERED: Hotspots at top, Stats & Keyboard at bottom -->
            <aside class="sidebar">
                <div class="sidebar-content">

                    <!-- About Panel -->
                    <div class="panel">
                        <div class="panel-header">
                            <i class="fas fa-map-marked-alt"></i>
                            <h3>How to use me</h3>
                            <div class="version">v5.0</div>
                        </div>
                        <div class="panel-content">
                            <div class="data-group">
                                <h4><i class="fas fa-info-circle"></i> About</h4>
                                <ul>
                                    <li><strong style="color: #3b82f6;">Blue:</strong> Education only (‚â•1,000 higher ed)
                                    </li>
                                    <li><strong style="color: #ef4444;">Red:</strong> Income only (‚â•1,000 HH ‚â•$100k)
                                    </li>
                                    <li><strong style="color: #8b5cf6;">Purple:</strong> Both criteria met</li>
                                    <li><strong>Marker Size:</strong> ‚àö(value) √ó scale</li>
                                    <li><strong>Hotspots:</strong> Top 50 counties by density</li>
                                </ul>
                                <p class="data-source">
                                    Data: ACS 2022 | Cache: 90 days<br>
                                    Threshold: 1,000+ for both criteria
                                </p>
                            </div>

                            <div class="action-buttons">
                                <button id="apiKeyBtn" class="btn btn-secondary">
                                    <i class="fas fa-key"></i> API Key
                                </button>
                                <button id="clearCacheBtn" class="btn btn-secondary">
                                    <i class="fas fa-trash-alt"></i> Clear Cache
                                </button>
                                <button id="reloadDataBtn" class="btn btn-primary">
                                    <i class="fas fa-sync-alt"></i> Load Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- HOTSPOT LIST - TOP (Most Important) -->
                    <div id="hotspot-list-container" class="hotspot-list-container">
                        <!-- Will be populated by JavaScript -->
                    </div>

                    <!-- STATISTICS PANEL - Bottom Section -->
                    <div class="stats-panel">
                        <h6><i class="fas fa-chart-bar"></i> Data Statistics</h6>
                        <div id="statsContent">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Education Only:</span>
                                <strong style="color: #1e40af;" id="statEducation">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Income Only:</span>
                                <strong style="color: #991b1b;" id="statIncome">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Both Criteria:</span>
                                <strong style="color: #6b21a8;" id="statBoth">0</strong>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                <span>Total Markers:</span>
                                <strong style="color: #1f2937;" id="statTotal">0</strong>
                            </div>
                        </div>
                    </div>

                    <!-- KEYBOARD NAVIGATION PANEL - Bottom -->
                    <div class="detailed-analysis">
                        <h5><i class="fas fa-keyboard"></i> Keyboard Navigation</h5>
                        <div class="analysis-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div><kbd>W</kbd> / <kbd>‚Üë</kbd> Jump to next marker</div>
                            <div><kbd>S</kbd> / <kbd>‚Üì</kbd> Jump to prev marker</div>
                            <div><kbd>A</kbd> / <kbd>‚Üê</kbd> Jump to prev marker</div>
                            <div><kbd>D</kbd> / <kbd>‚Üí</kbd> Jump to next marker</div>
                            <div><kbd>Shift</kbd> + Arrows</div>
                            <div>Pan map faster</div>
                            <div><kbd>+</kbd> / <kbd>-</kbd></div>
                            <div>Zoom in/out</div>
                            <div><kbd>F</kbd></div>
                            <div>Full Screen</div>
                            <div><kbd>R</kbd></div>
                            <div>Reset view</div>
                            <div><kbd>H</kbd></div>
                            <div>Toggle hotspots</div>
                            <div><kbd>C</kbd></div>
                            <div>Clear circles</div>
                            <div><kbd>Esc</kbd></div>
                            <div>Cancel drawing</div>
                        </div>
                        <div
                            style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #3b82f6;">
                            <i class="fas fa-mouse-pointer"></i>
                            <strong>Circle Drawing:</strong> Right-click + drag ‚Üí Left-click to finish
                        </div>
                    </div>

                </div>
            </aside>

            <!-- Main Map Area -->
            <main class="map-area">
                <div id="mapContainer" class="map-container"></div>

                <!-- Map Controls - Bottom Right -->
                <div class="map-controls bottom-right">
                    <div class="map-control-group">
                        <button id="zoomInBtn" class="map-control-btn" title="Zoom In (+)">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button id="zoomOutBtn" class="map-control-btn" title="Zoom Out (-)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button id="resetViewBtn" class="map-control-btn" title="Reset View (R)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button id="locateBtn" class="map-control-btn" title="Locate Me">
                            <i class="fas fa-location-crosshairs"></i>
                        </button>
                    </div>
                </div>

                <!-- Drawing Controls - Bottom Right -->
                <div class="draw-controls bottom-right">
                    <button id="drawCircleBtn" class="draw-btn"
                        title="Right-click + drag to draw, Left-click to finish">
                        <i class="fas fa-draw-circle"></i> Draw Circle
                    </button>
                    <button id="clearCirclesBtn" class="draw-btn" title="Clear all circles (C)">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button id="showHotspotsBtn" class="draw-btn" style="background: #ef4444; color: white;"
                        title="Show Top 50 County Hotspots">
                        <i class="fas fa-fire"></i> Hotspots
                    </button>
                </div>

                <!-- Map Legend with Toggles -->
                <div id="mapLegend" class="map-legend">
                    <div class="legend-header">
                        <div class="legend-title">Layer Controls</div>
                        <button class="legend-close">&times;</button>
                    </div>
                    <div class="legend-scale">
                        <div class="legend-item">
                            <input type="checkbox" id="toggleEducation" class="legend-checkbox" checked>
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <div class="legend-label">Education Only</div>
                        </div>
                        <div class="legend-item">
                            <input type="checkbox" id="toggleIncome" class="legend-checkbox" checked>
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <div class="legend-label">Income Only</div>
                        </div>
                        <div class="legend-item">
                            <input type="checkbox" id="toggleBoth" class="legend-checkbox" checked>
                            <div class="legend-color" style="background: #8b5cf6;"></div>
                            <div class="legend-label">Both Criteria</div>
                        </div>
                        <div class="legend-item">
                            <input type="checkbox" id="toggleHotspots" class="legend-checkbox" checked>
                            <div class="legend-color"
                                style="background: rgba(239,68,68,0.3); border: 2px dashed #ef4444;"></div>
                            <div class="legend-label">County Hotspots</div>
                        </div>
                        <div class="legend-info">
                            ‚úì = Visible | Right-click circle to remove
                        </div>
                    </div>
                </div>

                <!-- Coordinates Display -->
                <div class="coordinates-display">
                    <span><strong>Lat:</strong> <span id="currentLat">39.8283</span></span>
                    <span><strong>Lng:</strong> <span id="currentLng">-98.5795</span></span>
                    <span><strong>Zoom:</strong> <span id="currentZoom">4</span></span>
                    <span><strong>Mode:</strong> <span id="drawingMode">View</span></span>
                </div>
            </main>
        </div>

        <!-- Footer - Updated to show correct navigation -->
        <footer class="app-footer">
            <div class="footer-content">
                <div class="footer-left">
                    <span class="footer-brand">
                        <i class="fas fa-fire"></i>
                        ACS County Hotspots
                    </span>
                    <span class="footer-separator">‚Ä¢</span>
                    <span>WASD: Jump markers | Arrows: Pan map | R: Reset | F: Fullscreen</span>
                </div>
                <div class="footer-right">
                    <span id="footerCache">Cache: 90 days</span>
                    <span class="footer-separator">‚Ä¢</span>
                    <span>Right-click drag ‚Üí Left-click finish</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Notification Container -->
    <div class="notification-container"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Our JavaScript -->
    <script src="js/zipCodeIndex.js"></script>
    <script src="js/acsApiService.js"></script>
    <script src="js/spatialUtils.js"></script>
    <script src="js/mapVisualizer.js"></script>
    <script src="js/application.js"></script>

 <!-- CSS Load Verification Script - FIXED
<script>
    (function() {
        'use strict';
        
        // CSS files to check
        const cssFiles = [
            { name: 'styles.css', testId: 'test-styles', property: 'background-color', expected: 'rgb(59, 130, 246)' },
            { name: 'map.css', testId: 'test-map', property: 'background-color', expected: 'rgb(239, 68, 68)' },
            { name: 'notifications.css', testId: 'test-notifications', property: 'background-color', expected: 'rgb(16, 185, 129)' }
        ];
        
        const statusEl = document.getElementById('css-load-status');
        const failed = [];
        const loaded = [];
        
        // Helper to get computed style - FIXED: use specific property, not shorthand
        function getStyle(el, prop) {
            return window.getComputedStyle(el).getPropertyValue(prop).trim();
        }
        
        // Check each CSS file
        function checkCSS() {
            // Wait a bit for CSS to apply
            setTimeout(() => {
                cssFiles.forEach(file => {
                    const testEl = document.getElementById(file.testId);
                    if (testEl) {
                        const computedValue = getStyle(testEl, file.property);
                        const expectedRgb = file.expected;
                        
                        // FIXED: Check if the computed value CONTAINS the expected color
                        // Instead of exact match (due to shorthand properties)
                        if (!computedValue || computedValue === 'rgba(0, 0, 0, 0)' || computedValue === 'transparent') {
                            failed.push(`${file.name} - no style applied`);
                            console.error(`‚ùå CSS LOAD FAILED: ${file.name} - No styles detected`);
                        } else if (computedValue.includes(expectedRgb)) {
                            loaded.push(file.name);
                            console.log(`‚úÖ CSS LOADED: ${file.name} - ${computedValue}`);
                        } else {
                            failed.push(`${file.name} - wrong color: ${computedValue}`);
                            console.error(`‚ùå CSS LOAD FAILED: ${file.name} - Expected ${expectedRgb}, got ${computedValue}`);
                        }
                    } else {
                        failed.push(`${file.name} - test element not found`);
                        console.error(`‚ùå CSS LOAD FAILED: ${file.name} - Test element missing`);
                    }
                });
                
                // Show status banner
                if (failed.length > 0) {
                    statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> CSS LOAD ISSUES: ${failed.length} file(s) failed. ${loaded.length} loaded. Check console.`;
                    statusEl.style.display = 'block';
                    statusEl.classList.remove('success');
                    statusEl.style.background = '#dc2626';
                    
                    // Log summary
                    console.group('üìä CSS Load Summary');
                    console.log(`‚úÖ Loaded: ${loaded.join(', ')}`);
                    console.error(`‚ùå Failed: ${failed.join(' | ')}`);
                    console.groupEnd();
                    
                    // Add to loading overlay if visible
                    const loadingEl = document.getElementById('app-loading');
                    if (loadingEl && loadingEl.style.display !== 'none') {
                        const statsEl = document.querySelector('.loading-stats');
                        if (statsEl) {
                            const warningEl = document.createElement('div');
                            warningEl.style.marginTop = '16px';
                            warningEl.style.padding = '8px';
                            warningEl.style.background = '#dc2626';
                            warningEl.style.color = 'white';
                            warningEl.style.borderRadius = '6px';
                            warningEl.style.fontSize = '12px';
                            warningEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> CSS issues detected - but colors are present. App should work.`;
                            statsEl.appendChild(warningEl);
                        }
                    }
                } else {
                    statusEl.innerHTML = `<i class="fas fa-check-circle"></i> All CSS files loaded successfully (${loaded.length} files)`;
                    statusEl.style.display = 'block';
                    statusEl.classList.add('success');
                    statusEl.style.background = '#10b981';
                    
                    console.log(`‚úÖ CSS LOAD SUCCESS: All ${loaded.length} files loaded`);
                    
                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        statusEl.style.opacity = '0';
                        statusEl.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            statusEl.style.display = 'none';
                            statusEl.style.opacity = '1';
                        }, 500);
                    }, 3000);
                }
            }, 150); // Wait 150ms for CSS to apply
        }
        
        // Run check when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkCSS);
        } else {
            checkCSS();
        }
        
        // Also check after window load (for fonts/images)
        window.addEventListener('load', function() {
            setTimeout(checkCSS, 200);
        });
    })();
</script>

<!-- Fallback CSS Path Fixer - IMPROVED -->
<script>
    // If CSS fails to load completely, try alternative paths
    (function() {
        function tryAlternativePaths() {
            const testEl = document.getElementById('test-styles');
            if (testEl) {
                const bg = window.getComputedStyle(testEl).backgroundColor;
                // Check if it's actually transparent/empty (real failure)
                if (!bg || bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent') {
                    console.warn('‚ö†Ô∏è CSS not loaded, attempting to reload with ./ prefix...');
                    
                    // Try reloading with ./ prefix
                    const links = document.querySelectorAll('link[href^="css/"]');
                    links.forEach(link => {
                        const originalHref = link.href;
                        const newHref = originalHref.replace('css/', './css/');
                        if (originalHref !== newHref) {
                            link.href = newHref + '?v=' + Date.now();
                            console.log(`Reloading CSS: ${newHref}`);
                        }
                    });
                    
                    // If still not loaded, try absolute path
                    setTimeout(() => {
                        const bg2 = window.getComputedStyle(testEl).backgroundColor;
                        if (!bg2 || bg2 === 'rgba(0, 0, 0, 0)' || bg2 === 'transparent') {
                            console.warn('‚ö†Ô∏è CSS still not loaded, trying absolute path...');
                            
                            const path = window.location.pathname;
                            const repoName = path.split('/')[1];
                            const basePath = repoName ? `/${repoName}` : '';
                            
                            const links = document.querySelectorAll('link[href*="css/"]');
                            links.forEach(link => {
                                if (link.href.includes('css/')) {
                                    const filename = link.href.split('css/').pop();
                                    link.href = `${basePath}/css/${filename}?v=${Date.now()}`;
                                    console.log(`Reloading CSS: ${basePath}/css/${filename}`);
                                }
                            });
                        }
                    }, 200);
                } else {
                    // Colors are present - even if our test had a false positive, CSS is working
                    console.log('‚úÖ CSS colors detected - styles are applied correctly');
                }
            }
        }
        
        // Try alternative paths if initial check fails
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => setTimeout(tryAlternativePaths, 300));
        } else {
            setTimeout(tryAlternativePaths, 300);
        }
    })();
</script> -->

    <script>
        // Legend toggle handlers
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle legend visibility
            document.getElementById('toggleLegend')?.addEventListener('click', function () {
                const legend = document.getElementById('mapLegend');
                if (legend) {
                    legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
                }
            });

            // Legend close button
            document.querySelector('.legend-close')?.addEventListener('click', function () {
                document.getElementById('mapLegend').style.display = 'none';
            });

            // Layer toggle checkboxes
            document.getElementById('toggleEducation')?.addEventListener('change', function (e) {
                if (window.acsApp?.mapVisualizer) {
                    window.acsApp.mapVisualizer.toggleLayer('education', e.target.checked);
                }
            });

            document.getElementById('toggleIncome')?.addEventListener('change', function (e) {
                if (window.acsApp?.mapVisualizer) {
                    window.acsApp.mapVisualizer.toggleLayer('income', e.target.checked);
                }
            });

            document.getElementById('toggleBoth')?.addEventListener('change', function (e) {
                if (window.acsApp?.mapVisualizer) {
                    window.acsApp.mapVisualizer.toggleLayer('both', e.target.checked);
                }
            });

            document.getElementById('toggleHotspots')?.addEventListener('change', function (e) {
                if (window.acsApp?.mapVisualizer) {
                    window.acsApp.mapVisualizer.toggleHotspots(e.target.checked);
                }
            });

            // Update drawing mode indicator
            if (window.acsApp?.mapVisualizer) {
                const modeEl = document.getElementById('drawingMode');
                if (modeEl) {
                    setInterval(() => {
                        if (window.acsApp.mapVisualizer.isDrawing) {
                            modeEl.textContent = 'Drawing';
                            modeEl.style.color = '#10b981';
                        } else {
                            modeEl.textContent = 'View';
                            modeEl.style.color = '#6b7280';
                        }
                    }, 100);
                }
            }
        });
    </script>
</body>

</html>